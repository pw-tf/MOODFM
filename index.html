<script>
  // Fade in sections on scroll
  const sections = document.querySelectorAll('.section-fade-in');
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.style.opacity = '1';
        entry.target.style.transform = 'translateY(0)';
        observer.unobserve(entry.target);
      }
    });
  }, { threshold: 0.1 });
  sections.forEach(sec => observer.observe(sec));

  // Mobile bio "See more" toggle
  const toggleBioBtn = document.getElementById('toggleBioBtn');
  const fullBioContent = document.getElementById('fullBioContent');
  if (toggleBioBtn && fullBioContent) {
    if (window.innerWidth < 1024) {
      fullBioContent.classList.add('collapsed');
    }
    toggleBioBtn.addEventListener('click', () => {
      fullBioContent.classList.toggle('collapsed');
      const expanded = !fullBioContent.classList.contains('collapsed');
      toggleBioBtn.textContent = expanded ? 'Show less' : 'See more';
      toggleBioBtn.setAttribute('aria-expanded', expanded);
    });
  }

  // Social links toggle
  const toggleSocialsBtn = document.getElementById('toggleSocialsBtn');
  const socialLinksContainer = document.getElementById('socialLinksContainer');
  if (toggleSocialsBtn && socialLinksContainer) {
    toggleSocialsBtn.addEventListener('click', () => {
      socialLinksContainer.classList.toggle('expanded');
      const expanded = socialLinksContainer.classList.contains('expanded');
      toggleSocialsBtn.setAttribute('aria-expanded', expanded);
    });
  }

  // Fade sticky banner on scroll
  const stickyBanner = document.getElementById('stickyHeaderBanner');
  window.addEventListener('scroll', () => {
    if (stickyBanner) {
      stickyBanner.style.opacity = window.scrollY > 10 ? '0.5' : '1';
    }
  });

  // Profile picture slideshow modal (unchanged)
  const profilePic = document.getElementById('profilePic');
  const modalOverlay = document.getElementById('showModalOverlay');
  const modalContent = document.getElementById('showModalContent');
  const biopicImages = [
    "index/studiopics/biopic1.jpg",
    "index/studiopics/biopic2.jpg",
    "index/studiopics/biopic3.jpg",
    "index/studiopics/biopic4.png",
    "index/studiopics/biopic5.png",
    "index/studiopics/biopic6.jpg",
    "index/studiopics/biopic7.jpg"
  ];

  if (profilePic) {
    profilePic.addEventListener('click', () => openProfileModal(profilePic.src));
  }

  function openProfileModal(initialSrc) {
    modalContent.innerHTML = '';

    let currentIndex = biopicImages.findIndex(img => initialSrc.includes(img.split('/').pop()));
    if (currentIndex === -1) currentIndex = 0;

    const spinner = document.createElement('div');
    spinner.className = 'spinner border-4 border-gray-200 border-l-gray-600 rounded-full w-10 h-10 animate-spin absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2';
    modalContent.appendChild(spinner);

    const img = document.createElement('img');
    img.className = 'max-w-full max-h-[70vh] rounded-lg shadow-md opacity-0 transition-opacity';
    img.onload = () => {
      spinner.remove();
      img.classList.remove('opacity-0');
      img.classList.add('opacity-100');
    };
    img.src = biopicImages[currentIndex];
    modalContent.appendChild(img);

    const nav = document.createElement('div');
    nav.className = 'flex justify-between w-full mt-4';
    const prev = document.createElement('button');
    prev.textContent = 'Prev';
    prev.className = 'px-4 py-2 bg-gray-200 rounded-full hover:bg-gray-300';
    prev.onclick = () => {
      currentIndex = (currentIndex - 1 + biopicImages.length) % biopicImages.length;
      spinner.style.display = 'block';
      img.classList.add('opacity-0');
      img.src = biopicImages[currentIndex];
    };
    const counter = document.createElement('span');
    counter.textContent = `${currentIndex + 1} / ${biopicImages.length}`;
    counter.className = 'text-gray-700';
    const next = document.createElement('button');
    next.textContent = 'Next';
    next.className = 'px-4 py-2 bg-gray-200 rounded-full hover:bg-gray-300';
    next.onclick = () => {
      currentIndex = (currentIndex + 1) % biopicImages.length;
      spinner.style.display = 'block';
      img.classList.add('opacity-0');
      img.src = biopicImages[currentIndex];
      counter.textContent = `${currentIndex + 1} / ${biopicImages.length}`;
    };

    nav.append(prev, counter, next);
    modalContent.appendChild(nav);

    const closeBtn = document.createElement('button');
    closeBtn.textContent = 'Close';
    closeBtn.className = 'modal-close-button';
    closeBtn.onclick = closeModal;
    modalContent.appendChild(closeBtn);

    modalOverlay.classList.add('active');
    document.body.style.overflow = 'hidden';
  }

  // Show modal with player (unchanged)
  function openShowModal(card, autoplay = false) {
    modalContent.innerHTML = '';

    const originalIframe = card.querySelector('.audio-and-details-container iframe');
    const iframe = originalIframe.cloneNode(true);

    if (autoplay) {
      let src = iframe.src;
      if (!src.includes('autoplay=')) {
        iframe.src = src + (src.includes('?') ? '&' : '?') + 'autoplay=1';
      }
    }

    modalContent.appendChild(iframe);

    const title = document.createElement('h3');
    title.className = 'show-title font-eb-garamond font-semibold text-text-dark';
    title.textContent = card.querySelector('h3').textContent;
    modalContent.appendChild(title);

    const date = document.createElement('p');
    date.className = 'show-date';
    date.textContent = card.querySelector('p.text-text-medium').textContent;
    modalContent.appendChild(date);

    const buttonContainer = document.createElement('div');
    buttonContainer.className = 'flex gap-4 justify-center';

    const closeBtn = document.createElement('button');
    closeBtn.textContent = 'Close';
    closeBtn.className = 'modal-close-button';
    closeBtn.onclick = closeModal;
    buttonContainer.appendChild(closeBtn);

    const popOutBtn = document.createElement('button');
    popOutBtn.textContent = 'Pop Out';
    popOutBtn.className = 'modal-close-button';
    popOutBtn.onclick = () => {
      const urlParams = new URLSearchParams(iframe.src.split('?')[1] || '');
      const feed = urlParams.get('feed');
      if (feed) {
        const popUrl = `https://www.mixcloud.com/widget/iframe/?feed=${feed}&hide_cover=1&mini=1&autoplay=1`;
        window.open(popUrl, 'moodfm_player', 'width=400,height=300,resizable=yes,scrollbars=no');
      } else {
        alert('Unable to pop out this player');
      }
      closeModal();
    };
    buttonContainer.appendChild(popOutBtn);

    modalContent.appendChild(buttonContainer);

    modalOverlay.classList.add('active');
    document.body.style.overflow = 'hidden';
  }

  function closeModal() {
    const iframe = modalContent.querySelector('iframe');
    if (iframe) {
      iframe.src = iframe.src;
    }
    modalContent.innerHTML = '';
    modalOverlay.classList.remove('active');
    document.body.style.overflow = '';
  }

  // Attach listeners to show cards + iframe load handling
  function attachCardListeners(container) {
    const cards = container.querySelectorAll('.show-card');
    cards.forEach(card => {
      const playButton = card.querySelector('.custom-play-button-wrapper');
      if (playButton) {
        playButton.addEventListener('click', (e) => {
          e.stopPropagation();
          openShowModal(card, true);
        });
      }
      card.addEventListener('click', () => openShowModal(card, false));

      // Loading spinner handling
      const iframe = card.querySelector('iframe');
      const overlay = card.querySelector('.show-card-loading-overlay');
      if (iframe && overlay) {
        iframe.addEventListener('load', () => {
          overlay.style.opacity = '0';
          setTimeout(() => overlay.remove(), 400);
        });
      }
    });
  }

  // ESC key closes modal
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modalOverlay.classList.contains('active')) {
      closeModal();
    }
  });

  // Mobile "Previous Broadcasts" button scroll
  const mobileBroadcastsBtn = document.getElementById('mobileBroadcastsBtn');
  const showsSection = document.getElementById('shows');
  if (mobileBroadcastsBtn && showsSection) {
    mobileBroadcastsBtn.addEventListener('click', () => {
      showsSection.scrollIntoView({ behavior: 'smooth' });
    });
  }

  // Load shows from JSON
  fetch('shows.json')
    .then(response => {
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      return response.json();
    })
    .then(shows => {
      const container = document.getElementById('showsContainer');
      if (!container) return;

      if (shows.length === 0) {
        container.innerHTML = '<p class="text-center py-10 text-text-medium">No shows yet.</p>';
        return;
      }

      shows.forEach(show => {
        const card = document.createElement('div');
        card.className = 'show-card w-64 sm:w-72 bg-white rounded-xl shadow-md p-5 flex flex-col items-center border border-border-light';

        card.innerHTML = `
          <!-- Loading overlay with spinner -->
          <div class="show-card-loading-overlay">
            <div class="show-card-loading-spinner"></div>
          </div>

          <img src="${show.thumbnail}" alt="${show.title} Cover" class="show-image w-full h-auto rounded-lg object-cover shadow-sm aspect-square">
          <h3 class="font-eb-garamond text-2xl font-semibold text-text-dark mt-4 mb-1 text-center">${show.title}</h3>
          <p class="text-text-medium text-center text-xs mb-3">${show.date}</p>
          <div class="custom-play-button-wrapper">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8 text-text-dark">
              <path fill-rule="evenodd" d="M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.348c1.295.712 1.295 2.566 0 3.278l-11.54 6.347c-1.25.687-2.779-.217-2.779-1.643V5.653Z" clip-rule="evenodd" />
            </svg>
          </div>
          <div class="audio-and-details-container">
            <iframe width="100%" height="120" src="${show.iframeSrc}" frameborder="0" allow="encrypted-media; fullscreen; autoplay; idle-detection; speaker-selection; web-share;" loading="lazy"></iframe>
          </div>
        `;

        container.appendChild(card);
      });

      attachCardListeners(container);
    })
    .catch(error => {
      console.error('Failed to load shows.json:', error);
      const container = document.getElementById('showsContainer');
      if (container) {
        container.innerHTML = '<p class="text-center py-10 text-red-600">Error loading shows</p>';
      }
    });
</script>
